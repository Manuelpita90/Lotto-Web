<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lotto IA M√≥vil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PWA: Manifiesto y Metaetiquetas -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes fadeInButton {
            to {
                opacity: 1;
            }
        }

        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --primary: #00ffaa;
            --text: #fff;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding-bottom: 80px;
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            color: var(--primary);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* Tabs */
        .tab-content {
            display: none;
            padding: 15px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: linear-gradient(145deg, #232323, #1a1a1a);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5), 
                        -5px -5px 15px rgba(255,255,255,0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s;
            animation: slideInCard 0.5s cubic-bezier(0.25, 1, 0.5, 1) both;
        }

        .card:active {
            transform: scale(0.98);
        }

        .animal-icon {
            font-size: 34px;
            margin-right: 16px;
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .info h3 {
            margin: 0 0 4px 0;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 0.5px;
        }

        .info p {
            margin: 0;
            color: #aaa;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .badge {
            background: rgba(0, 255, 170, 0.1);
            color: var(--primary);
            padding: 8px 14px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 14px;
            border: 1px solid rgba(0, 255, 170, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 170, 0.15);
            text-shadow: 0 0 8px rgba(0, 255, 170, 0.5);
        }

        /* Predicciones Grid */
        .pred-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* 3 columnas en desktop/tablet */
            gap: 10px;
        }

        @media (max-width: 600px) {
            .pred-grid {
                grid-template-columns: 1fr;
                /* 1 columna en m√≥vil */
            }
        }

        .pred-column {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid #333;
        }

        .pred-column h3 {
            text-align: center;
            margin: 0 0 10px 0;
            font-size: 14px;
            color: var(--primary);
            text-transform: uppercase;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .pred-card {
            border: 1px solid rgba(0, 255, 170, 0.3);
            background: linear-gradient(145deg, #1e1e1e, #252525);
            margin-bottom: 8px;
            /* Espacio entre cartas */
        }

        .stat-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 12px;
            animation: slideInCard 0.5s cubic-bezier(0.25, 1, 0.5, 1) both;
        }

        .days-badge {
            background: #ff5555;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .prob-bar {
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .prob-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffaa, #00aaff);
            border-radius: 3px;
            transition: width 1s ease-out;
        }

        .rank-badge {
            background: #333;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Bottom Nav */
        .nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #000;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid #333;
            z-index: 100;
        }

        .nav-item {
            color: #666;
            text-align: center;
            font-size: 11px;
            cursor: pointer;
            flex: 1;
            transition: color 0.2s;
        }

        .nav-item i {
            font-size: 22px;
            margin-bottom: 5px;
            display: block;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active i {
            transform: scale(1.1);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            font-size: 30px;
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #121212;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #splash-screen img {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 255, 170, 0.2);
            animation: pulseLogo 2s infinite;
        }

        @keyframes pulseLogo {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes slideInCard {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Historial */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none; /* Controlado por JS */
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s;
        }

        .modal-content {
            background: #1e1e1e;
            width: 85%;
            max-width: 350px;
            max-height: 70vh;
            border-radius: 20px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-list {
            padding: 0;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
        }
        .history-item:last-child { border-bottom: none; }

        /* Drag Handle (Barra de agarre) */
        .modal-drag-handle {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 10px auto 5px;
        }

        /* Indicador de Estado Realtime */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #555;
            margin-left: 8px;
            vertical-align: middle;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .status-dot.connected { background-color: #00ffaa; box-shadow: 0 0 8px #00ffaa; }
        .status-dot.disconnected { background-color: #ff5555; box-shadow: 0 0 8px #ff5555; }

        /* --- SKELETON LOADING --- */
        .skeleton {
            background: linear-gradient(90deg, #2b2b36 25%, #3a3a45 50%, #2b2b36 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
            color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        .skeleton-text {
            height: 14px;
            margin-bottom: 6px;
            border-radius: 4px;
        }
        .skeleton-card { pointer-events: none; }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>

<body>

    <!-- SPLASH SCREEN -->
    <div id="debug-log"
        style="position:fixed; bottom:0; left:0; width:100%; height:150px; background:rgba(0,0,0,0.8); color:#0f0; font-family:monospace; font-size:10px; overflow-y:scroll; z-index:9999; padding:5px; display:none;">
        DEBUG LOG:<br></div>

    <div id="splash-screen">
        <img src="icon.png" alt="Logo">
        <h2 style="color: var(--primary); margin: 0; letter-spacing: 2px; font-size: 24px;">LOTTO IA</h2>
        <p style="color: #666; font-size: 12px; margin-top: 10px;">Inteligencia Artificial</p>
        <audio id="splash-audio" src="startup.mp3" preload="auto"></audio>
        <!-- Bot√≥n de emergencia por si JS falla -->
        <button onclick="document.getElementById('splash-screen').style.display='none'"
            style="margin-top:20px; padding:10px 20px; background:#333; color:#fff; border:1px solid #555; border-radius:10px; opacity:0; animation:fadeInButton 2s 5s forwards; cursor:pointer;">Entrar</button>
    </div>

    <!-- Fail-safe script -->
    <script>
        setTimeout(() => {
            const s = document.getElementById('splash-screen');
            if (s) s.style.display = 'none';
        }, 8000);
    </script>

    <div class="header">
        <h1><i class="fas fa-robot"></i> Lotto IA <span id="realtime-indicator" class="status-dot" title="Estado de conexi√≥n"></span></h1>
        <button id="btn-install"
            style="display: none; position: absolute; right: 15px; top: 12px; background: var(--primary); border: none; color: #000; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 11px; cursor: pointer; box-shadow: 0 0 10px rgba(0,255,170,0.4);">
            <i class="fas fa-download"></i> INSTALAR
        </button>
    </div>

    <!-- PESTA√ëA 1: RESULTADOS -->
    <div id="tab-resultados" class="tab-content active">
        <h2 style="font-size: 13px; color: #666; margin: 10px 0 15px; text-transform: uppercase; letter-spacing: 1px;">
            Resultados de Hoy</h2>
        <div id="lista-resultados">
            <div class="loading"><i class="fas fa-circle-notch fa-spin"></i><br>Cargando resultados...</div>
        </div>
    </div>

    <!-- PESTA√ëA 2: PRON√ìSTICOS -->
    <div id="tab-pronosticos" class="tab-content">
        <h2 style="font-size: 13px; color: #666; margin: 10px 0 15px; text-transform: uppercase; letter-spacing: 1px;">
            Sugerencias IA (Pr√≥ximo Sorteo)</h2>
        <div id="lista-predicciones">
            <div class="loading"><i class="fas fa-brain"></i><br>Esperando an√°lisis...</div>
        </div>
    </div>

    <!-- PESTA√ëA 3: ESTAD√çSTICAS (NUEVO) -->
    <div id="tab-estadisticas" class="tab-content">
        <h2 style="font-size: 13px; color: #666; margin: 10px 0 15px; text-transform: uppercase; letter-spacing: 1px;">
            M√°s Atrasados (Top 10)</h2>
        <div id="lista-estadisticas">
            <div class="loading"><i class="fas fa-chart-bar"></i><br>Cargando datos...</div>
        </div>
    </div>

    <!-- PESTA√ëA 4: INFO -->
    <div id="tab-info" class="tab-content">
        <div class="card" style="display: block; text-align: center; padding: 30px;">
            <i class="fas fa-wifi" style="font-size: 40px; color: var(--primary); margin-bottom: 15px;"></i>
            <h3 style="color: #fff;">Sistema Conectado</h3>
            <p style="margin-top: 10px;">Esta aplicaci√≥n recibe datos en tiempo real desde el servidor central Lotto
                IA.
            </p>
            <div style="margin-top: 20px; font-size: 12px; color: #555;">Desarrollado por AJP-Logic</div>
        </div>
    </div>

    <!-- MODAL HISTORIAL -->
    <div id="modal-historial" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-header">
                <h3 id="modal-animal-title" style="margin:0; color:var(--primary);">Historial</h3>
                <button onclick="cerrarModalHistorial()" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="modal-animal-list" class="history-list"></div>
        </div>
    </div>

    <!-- FAB Recargar (M√≥vil) -->
    <button id="fab-reload" class="fab-btn" title="Recargar Datos">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- NAVEGACI√ìN -->
    <div class="nav">
        <div class="nav-item active" onclick="cambiarTab('resultados', this)">
            <i class="fas fa-list-ol"></i> Resultados
        </div>
        <div class="nav-item" onclick="cambiarTab('pronosticos', this)">
            <i class="fas fa-bolt"></i> Pron√≥sticos
        </div>
        <div class="nav-item" onclick="cambiarTab('estadisticas', this)">
            <i class="fas fa-chart-line"></i> Stats
        </div>
        <div class="nav-item" onclick="cambiarTab('info', this)">
            <i class="fas fa-info-circle"></i> Info
        </div>
    </div>

    <script>
        // --- LOGGER (DEBUG EN PANTALLA) ---
        function log(msg) {
            console.log(msg);
            const d = document.getElementById('debug-log');
            if (d) d.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
        }

        // Activar debug si hay parametro ?debug=true
        if (window.location.search.includes('debug=true')) {
            document.getElementById('debug-log').style.display = 'block';
        }

        // --- 0. L√ìGICA SPLASH SCREEN (PRIORIDAD ALTA) ---
        // Definimos esto AL PRINCIPIO para asegurar que se ejecute incluso si hay errores de red abajo
        function ocultarSplash() {
            const splash = document.getElementById('splash-screen');
            if (!splash || splash.style.display === 'none') return;

            // Intentar reproducir audio
            const audio = document.getElementById('splash-audio');
            if (audio) audio.play().catch(() => { });

            splash.style.opacity = '0';
            setTimeout(() => { splash.style.display = 'none'; }, 500);
        }

        // 1. M√©todo normal: Esperar a que cargue todo + 2 segundos
        window.addEventListener('load', () => setTimeout(ocultarSplash, 2000));

        // 2. M√©todo de seguridad: Forzar cierre a los 7 segundos si la carga falla (Internet lento)
        setTimeout(ocultarSplash, 7000);

        // --- CONFIGURACI√ìN Y ARRANQUE ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Esperar activamente a que Supabase cargue (Hasta 5 segundos)
            let intentos = 0;
            while (!window.supabase && intentos < 20) {
                console.log(`Esperando a Supabase... (${intentos + 1}/20)`);
                await new Promise(r => setTimeout(r, 250)); // Esperar 250ms
                intentos++;
            }

            // MODO WEB (Supabase) vs MODO ESCRITORIO (API)
            if (window.api) {
                log("Modo Escritorio Detectado");
                iniciarApp();
            } else {
                log("Modo Web Detectado");

                const SUPABASE_URL = 'https://ojmqvkzqwnexiellqlnj.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qbXF2a3pxd25leGllbGxxbG5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5NDU4NjUsImV4cCI6MjA4NjUyMTg2NX0.8mRvyiQ43dQH01aGdezVbV8LwfA9YWlY2sjEsGvQhAY';

                if (window.supabase) {
                    try {
                        let supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                        log("Supabase inicializado correctamente.");
                        window.supabaseInstance = supabase;
                        iniciarApp();
                    } catch (err) {
                        log("Error inicializando Supabase: " + err.message);
                        mostrarErrorGlobal();
                    }
                } else {
                    log("FATAL: Supabase no carg√≥ despu√©s de esperar.");
                    mostrarErrorGlobal();
                }
            }
        });

        function mostrarErrorGlobal() {
            document.getElementById('lista-resultados').innerHTML = '<div style="color:red; padding:20px;">Error: No se pudo conectar al servidor.</div>';
            document.getElementById('lista-predicciones').innerHTML = '<div style="color:red; padding:20px;">Sin conexi√≥n.</div>';
        }

        // --- FUNCIONES (Definidas fuera para ser accesibles, pero usan window.supabaseInstance) ---

        // Mapa de Iconos
        const iconos = { 'Delf√≠n': 'üê¨', 'Ballena': 'üêã', 'Carnero': 'üêè', 'Toro': 'üêÇ', 'Ciempi√©s': 'üêõ', 'Alacr√°n': 'ü¶Ç', 'Le√≥n': 'ü¶Å', 'Rana': 'üê∏', 'Perico': 'ü¶ú', 'Rat√≥n': 'üêÅ', '√Åguila': 'ü¶Ö', 'Tigre': 'üêÖ', 'Gato': 'üêà', 'Caballo': 'üêé', 'Mono': 'üêí', 'Paloma': 'üïäÔ∏è', 'Zorro': 'ü¶ä', 'Oso': 'üêª', 'Pavo': 'ü¶É', 'Burro': 'üêê', 'Chivo': 'üêê', 'Cochino': 'üêñ', 'Gallo': 'üêì', 'Camello': 'üê™', 'Zebra': 'ü¶ì', 'Iguana': 'ü¶é', 'Gallina': 'üêî', 'Vaca': 'üêÑ', 'Perro': 'üêï', 'Zamuro': 'ü¶Ö', 'Elefante': 'üêò', 'Caim√°n': 'üêä', 'Lapa': 'ü¶¶', 'Ardilla': 'üêøÔ∏è', 'Pescado': 'üêü', 'Venado': 'ü¶å', 'Jirafa': 'ü¶í', 'Culebra': 'üêç' };

        // Mapa de Colores (NUEVO)
        const coloresAnimales = {
            'Delf√≠n': '#29b6f6', 'Ballena': '#29b6f6', 'Pescado': '#29b6f6', 'Rana': '#66bb6a', 'Caim√°n': '#2e7d32', // Agua/Verde
            'Le√≥n': '#ff5722', 'Tigre': '#ff9800', '√Åguila': '#ff5722', 'Alacr√°n': '#ff5722', 'Toro': '#795548', // Fuego/Tierra
            'Vaca': '#795548', 'Burro': '#8d6e63', 'Chivo': '#a1887f', 'Cochino': '#f48fb1', 'Caballo': '#a1887f', // Granja
            'Paloma': '#90a4ae', 'Perico': '#ffeb3b', 'Gallo': '#ff5722', 'Gallina': '#ffb74d', 'Pavo': '#607d8b', // Aves
            'Culebra': '#4caf50', 'Iguana': '#8bc34a', 'Mono': '#795548', 'Jirafa': '#ffeb3b', 'Zebra': '#bdbdbd', // Selva
            'Rat√≥n': '#9e9e9e', 'Ardilla': '#ffcc80', 'Lapa': '#8d6e63', 'Ciempi√©s': '#ec407a', 'Gato': '#ffab91', 'Perro': '#d7ccc8', // Peque√±os
            'Elefante': '#9e9e9e', 'Zamuro': '#455a64', 'Camello': '#ffca28', 'Venado': '#a1887f', 'Oso': '#5d4037', 'Zorro': '#ff7043', 'Carnero': '#bdbdbd'
        };

        function obtenerColor(animal) {
            return coloresAnimales[animal] || '#ffffff';
        }

        // --- SKELETON GENERATOR ---
        function getSkeletonHTML() {
            return Array(5).fill(0).map(() => `
                <div class="card skeleton-card">
                    <div style="display:flex; align-items:center;">
                        <div class="animal-icon skeleton"></div>
                        <div class="info" style="width: 120px;">
                            <div class="skeleton skeleton-text" style="width: 80%;">.</div>
                            <div class="skeleton skeleton-text" style="width: 50%;">.</div>
                        </div>
                    </div>
                    <div class="badge skeleton" style="width: 50px; height: 24px;">.</div>
                </div>
            `).join('');
        }

        // --- MODAL LOGIC ---
        function cerrarModalHistorial() {
            const modal = document.getElementById('modal-historial');
            modal.style.display = 'none';
            // Resetear posici√≥n por si se cerr√≥ mientras se arrastraba
            const content = modal.querySelector('.modal-content');
            if (content) content.style.transform = '';
        }

        // --- SWIPE DOWN TO CLOSE (L√≥gica de Deslizamiento) ---
        (function() {
            const modal = document.getElementById('modal-historial');
            const content = modal.querySelector('.modal-content');
            const list = document.getElementById('modal-animal-list');
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            content.addEventListener('touchstart', (e) => {
                // Solo permitir arrastrar si la lista est√° al principio (scroll 0)
                if (list.scrollTop <= 0) {
                    startY = e.touches[0].clientY;
                    currentY = startY;
                    isDragging = true;
                    content.style.transition = 'none'; // Quitar animaci√≥n para que siga el dedo al instante
                }
            }, { passive: true });

            content.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                // Solo mover si se arrastra hacia abajo (diff positivo)
                if (diff > 0) content.style.transform = `translateY(${diff}px)`;
            }, { passive: true });

            content.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                content.style.transition = 'transform 0.2s ease-out'; // Restaurar animaci√≥n suave
                
                // Si se baj√≥ m√°s de 100px, cerrar. Si no, volver a posici√≥n original.
                if (currentY - startY > 100) {
                    cerrarModalHistorial();
                } else {
                    content.style.transform = '';
                }
            });
        })();

        async function abrirHistorialAnimal(animal) {
            const modal = document.getElementById('modal-historial');
            const title = document.getElementById('modal-animal-title');
            const list = document.getElementById('modal-animal-list');
            
            title.innerText = animal;
            title.style.color = obtenerColor(animal);
            list.innerHTML = '<div class="loading"><i class="fas fa-circle-notch fa-spin"></i> Buscando...</div>';
            modal.style.display = 'flex';

            if (!window.supabaseInstance) {
                list.innerHTML = '<div style="text-align:center; padding:20px;">Sin conexi√≥n.</div>';
                return;
            }

            const { data, error } = await window.supabaseInstance
                .from('sorteos')
                .select('*')
                .eq('animal', animal)
                .order('fecha', { ascending: false })
                .order('hora', { ascending: false })
                .limit(15);

            if (error || !data || data.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px;">Sin registros recientes.</div>';
                return;
            }

            list.innerHTML = data.map(r => `
                <div class="history-item">
                    <span style="color:#888;">${r.fecha}</span>
                    <span style="font-weight:bold; color:#fff;">${r.hora}</span>
                    <span class="badge" style="font-size:10px; padding:4px 8px;">${r.numero}</span>
                </div>
            `).join('');
        }

        async function cargarResultados() {
            const container = document.getElementById('lista-resultados');
            let data = [];
            let error = null;

            // Mostrar Skeleton mientras carga
            container.innerHTML = getSkeletonHTML();

            // 1. INTENTAR MODO ESCRITORIO (Prioridad)
            if (window.api) {
                try {
                    // Desktop ya devuelve los datos procesados desde SQLite
                    data = await window.api.obtenerResultadosHoy();
                } catch (e) {
                    console.error("Error API Desktop:", e);
                    error = e;
                }
            }
            // 2. MODO WEB (Supabase)
            else if (window.supabaseInstance) {
                const supabase = window.supabaseInstance;
                // Usar fecha LOCAL
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hoy = `${year}-${month}-${day}`;

                const res = await supabase.from('sorteos').select('*').eq('fecha', hoy);
                data = res.data;
                error = res.error;
            } else {
                return; // Ni uno ni otro
            }

            if (error) {
                container.innerHTML = `<div style="text-align:center; padding:20px; color:#ff5555;">Error de conexi√≥n</div>`;
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#444;"><i class="fas fa-clock" style="font-size:30px; margin-bottom:10px;"></i><br>Esperando primer sorteo...</div>';
                return;
            }

            // ORDENAR CRONOL√ìGICAMENTE (Fix 8am vs 10am)
            data.sort((a, b) => {
                const dateA = new Date(`1970/01/01 ${a.hora}`);
                const dateB = new Date(`1970/01/01 ${b.hora}`);
                return dateA - dateB;
            });

            let html = '';
            data.forEach((r, i) => {
                const icono = iconos[r.animal] || 'üé≤';
                const color = obtenerColor(r.animal);
                html += `
                <div class="card" onclick="abrirHistorialAnimal('${r.animal}')" style="animation-delay: ${i * 0.05}s; border-left: 5px solid ${color}; cursor:pointer;">
                    <div style="display:flex; align-items:center;">
                        <div class="animal-icon" style="color: ${color}">${icono}</div>
                        <div class="info">
                            <h3 style="color: ${color}">${r.numero} - ${r.animal}</h3>
                            <p>Sorteo Oficial</p>
                        </div>
                    </div>
                    <div class="badge" style="color: ${color}; border-color: ${color}; background: ${color}15">${r.hora}</div>
                </div>
            `;
            });
            container.innerHTML = html;
        }

        async function cargarPredicciones() {
            const container = document.getElementById('lista-predicciones');
            let data = [];
            let error = null;

            // 1. DESKTOP
            if (window.api) {
                try {
                    data = await window.api.obtenerPrediccion();
                } catch (e) { error = e; }
            }
            // 2. WEB
            else if (window.supabaseInstance) {
                const res = await window.supabaseInstance
                    .from('predicciones')
                    .select('*')
                    .order('ranking', { ascending: true });
                data = res.data;
                error = res.error;
            } else { return; }

            if (error) {
                console.error("Error cargando predicciones:", error);
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#ff5555;">Error al cargar.</div>';
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#444;"><i class="fas fa-magic" style="font-size:30px; margin-bottom:10px;"></i><br>Esperando que la App de Escritorio genere predicciones...</div>';
                return;
            }

            const preds = data;

            if (preds.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#444;">Sin patrones claros a√∫n.</div>';
                return;
            }

            // Renderizar GRID de 3 Columnas
            let html = '<div class="pred-grid">';

            const groups = {
                'üî• Calientes': data.filter(p => p.ranking <= 2),
                'üîí Fijos': data.filter(p => p.ranking >= 3 && p.ranking <= 4),
                'üí£ Explosivos': data.filter(p => p.ranking >= 5)
            };

            for (const [titulo, items] of Object.entries(groups)) {
                html += `<div class="pred-column"><h3>${titulo}</h3>`;

                if (items.length === 0) {
                    html += `<div style="text-align:center; color:#666; font-size:12px;">...</div>`;
                } else {
                    items.forEach((p, i) => {
                        const icono = iconos[p.animal] || 'üîÆ';
                        const color = obtenerColor(p.animal);
                        html += `
                        <div class="card pred-card" onclick="abrirHistorialAnimal('${p.animal}')" style="animation-delay: ${i * 0.1}s; border-left: 4px solid ${color}; cursor:pointer;">
                            <div style="width:100%">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div style="display:flex; align-items:center;">
                                        <div class="animal-icon" style="font-size:20px; margin-right:8px; width:auto;">${icono}</div>
                                        <div class="info">
                                            <h3 style="font-size:14px; color:${color}">${p.numero} - ${p.animal}</h3>
                                        </div>
                                    </div>
                                    <div style="color:${color}; font-weight:bold; font-size:12px;">${p.probabilidad}%</div>
                                </div>
                                <div class="prob-bar">
                                    <div class="prob-fill" style="width: ${p.probabilidad}%; background: ${color}"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    });
                }
                html += `</div>`; // Cerrar columna
            }
            html += '</div>'; // Cerrar grid
            container.innerHTML = html;
        }

        async function cargarEstadisticas() {
            const container = document.getElementById('lista-estadisticas');
            let data = [];
            let error = null;

            // 1. DESKTOP
            if (window.api) {
                try {
                    data = await window.api.obtenerEstadisticas();
                    if (data) data = data.slice(0, 10);
                } catch (e) { error = e; }
            }
            // 2. WEB
            else if (window.supabaseInstance) {
                const res = await window.supabaseInstance
                    .from('estadisticas')
                    .select('*')
                    .order('dias_sin_salir', { ascending: false })
                    .limit(10);
                data = res.data;
                error = res.error;
            } else { return; }

            if (error) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#ff5555;">Error obteniendo estad√≠sticas</div>';
                return;
            }
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#444;"><i class="fas fa-chart-bar" style="font-size:30px;"></i><br>A√∫n no hay estad√≠sticas sincronizadas.</div>';
                return;
            }

            let html = '';
            data.forEach((s, i) => {
                const icono = iconos[s.animal] || 'üìä';
                const color = obtenerColor(s.animal);
                html += `
                <div class="stat-card" onclick="abrirHistorialAnimal('${s.animal}')" style="animation-delay: ${i * 0.05}s; border-left: 4px solid ${color}; cursor:pointer;">
                    <div style="display:flex; align-items:center;">
                            <div class="animal-icon" style="font-size:24px;">${icono}</div>
                            <div>
                                <div style="color:${color}; font-weight:bold;">${s.numero} - ${s.animal}</div>
                                <div style="color:#666; font-size:11px;">Ult. vez: ${s.numero}</div>
                            </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="days-badge" style="background:${color}">${s.dias_sin_salir} d√≠as</div>
                    </div>
                </div>
            `;
            });
            container.innerHTML = html;
        }

        function iniciarApp() {
            // Iniciar
            cargarResultados();
            cargarPredicciones();
            cargarEstadisticas();

            // --- REALTIME SUBSCRIPTIONS ---
            if (window.supabaseInstance) {
                const channel = window.supabaseInstance.channel('cambios-lotto')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'sorteos' },
                        (payload) => {
                            console.log('Cambio en sorteos:', payload);
                            cargarResultados();
                        }
                    ).subscribe((status) => {
                        const indicator = document.getElementById('realtime-indicator');
                        // Monitor de estado de conexi√≥n Realtime
                        if (status === 'SUBSCRIBED') {
                            console.log('üü¢ Conectado a actualizaciones en tiempo real');
                            if (indicator) indicator.className = 'status-dot connected';
                        } else {
                            console.log('üî¥ Estado Realtime:', status);
                            if (indicator) indicator.className = 'status-dot disconnected';
                        }
                    });
            }
        }

        // --- UI LOGIC ---
        window.cambiarTab = function (tabId, element) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById('tab-' + tabId).classList.add('active');
            element.classList.add('active');
        }

        // Iniciar (Solo si no se llama desde iniciarApp, aunque iniciarApp es el punto de entrada principal)
        // cargarResultados();
        // cargarPredicciones();

        // --- REGISTRO PWA (SERVICE WORKER) ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker registrado:', reg.scope))
                .catch(err => console.log('Error SW:', err));
        }

        // --- PWA INSTALLATION ---
        let deferredPrompt;
        const btnInstall = document.getElementById('btn-install');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir que Chrome muestre el prompt autom√°ticamente
            e.preventDefault();
            // Guardar el evento para dispararlo despu√©s
            deferredPrompt = e;
            // Mostrar el bot√≥n
            btnInstall.style.display = 'block';
        });

        btnInstall.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                btnInstall.style.display = 'none';
            }
        });

        window.addEventListener('appinstalled', () => {
            btnInstall.style.display = 'none';
        });
    </script>
</body>

</html>